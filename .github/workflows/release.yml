name: Publish

on:
  workflow_dispatch:
  push:
    tags:
      - app-v*

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target universal-apple-darwin --bundles app,dmg,updater
          - platform: ubuntu-22.04
            args: --bundles appimage,deb,updater
          - platform: windows-latest
            args: --bundles msi,updater

    runs-on: ${{ matrix.platform }}

    env:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      # Prefer the official env var name, but keep compatibility with older secret naming.
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD || secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD || secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      TERM: xterm-256color
      HAS_WINDOWS_CERT: ${{ secrets.WINDOWS_CERTIFICATE != '' && secrets.WINDOWS_CERTIFICATE_PASSWORD != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify tag matches app version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          node -e "const v=require('./src-tauri/tauri.conf.json').package.version; const expected='app-v'+v; const tag=process.env.GITHUB_REF_NAME; if(tag!==expected){console.error(`Tag '${tag}' does not match app version '${v}' (expected '${expected}').`); process.exit(1)}"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libfuse2 libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Import Apple Developer Certificate (macOS only)
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning build.keychain

      - name: Resolve Apple Signing Identity (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -n 1)
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          echo "APPLE_SIGNING_IDENTITY=$CERT_ID" >> "$GITHUB_ENV"

      - name: Import Windows Code Signing Certificate (Windows only)
        if: matrix.platform == 'windows-latest' && env.HAS_WINDOWS_CERT == 'true'
        shell: pwsh
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          $pfxBytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          [IO.File]::WriteAllBytes("certificate.pfx", $pfxBytes)
          $password = ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText
          $imported = Import-PfxCertificate -FilePath certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password $password
          if (-not $imported) { throw "Failed to import PFX" }
          $thumb = $imported.Thumbprint
          "WINDOWS_CERTIFICATE_THUMBPRINT=$thumb" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Write Windows Signing Config (Windows only)
        if: matrix.platform == 'windows-latest' && env.WINDOWS_CERTIFICATE_THUMBPRINT != ''
        shell: pwsh
        run: |
          $thumb = $env:WINDOWS_CERTIFICATE_THUMBPRINT
          if (-not $thumb) { throw "Missing WINDOWS_CERTIFICATE_THUMBPRINT" }
          $configObj = @{
            tauri = @{
              bundle = @{
                windows = @{
                  certificateThumbprint = $thumb
                }
              }
            }
          }
          $configObj | ConvertTo-Json -Depth 8 | Out-File -FilePath src-tauri/tauri.conf.windows-sign.json -Encoding utf8

      - uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'app-v__VERSION__' }}
          releaseName: Copy Pasta v__VERSION__
          releaseBody: Download the latest version of Copy Pasta.
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}${{ matrix.platform == 'windows-latest' && env.WINDOWS_CERTIFICATE_THUMBPRINT != '' && ' --config src-tauri/tauri.conf.windows-sign.json' || '' }}
